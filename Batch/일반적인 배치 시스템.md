# 배치(Batch)

데이터를 실시간으로 처리하는 것이 아닌, 일괄적으로 모아서 처리하는 작업을 의미한다. 하루동안 쌓인 데이터를 배치 작업을 통해 특정 시간에 한 번에 처리하는 작업이다. 주로 API 통신으로 처리할 수 없는 경우 사용한다.

배치 시스템에 대한 예시는 다음과 같다.
1. 매일 새벽 1시에 전일에 거래한 내역을 기반으로 총 수익금을 계산한다.
2. 매일 새벽 3시에 종목별 거래량을 기반으로 다음날 거래를 해볼만 한 종목을 탐색한다.
3. 1분마다 거래량이 많은 종목을 찾아 텔레그램으로 전송한다.
4. 특정 장애가 나서 그 장애에 대한 데이터 백업을 해야하는 상황에 데이터의 양이 많기 때문에 활용하기도 한다.

## 배치의 특성

- 대량의 데이터 처리
- 특정 시간에 자동화 프로그램을 실행
	- 알림 보내기
	- 월별 리포트 만들기
- 작업을 일괄적으로 처리
- 시간이 오래 소요될 수 있음
- 야간과 같이 컴퓨팅 리소스를 덜 사용하는 시간대에 처리됨

## 일반적인 배치 동작 방식

특정 기능을 수행하는 테스크와 이를 정기적으로 수행시키는 스케줄러가 존재한다. 테스크에는 배치 작업을 통해 수행해야 하는 작업이 구현되어 있고, 스케줄러는 테스크를 일정한 시간에 실행시킬 수 있도록 한다.

수행하야 하는 테스크 유형에 따라 다르게 구현될 수 있지만 대부분 비슷한 형식으로 동작된다.

![일반적인 배치 동작 방식.png](/media/Batch/일반적인%20배치%20동작%20방식.png)
- 데이터베이스, 파일, 큐 등에서 데이터 읽기 (READ)
- 데이터를 정의한 방식으로 처리 (PROCESS)
- 처리한 데이터를 쓰기 (WRITE)

> 해당 기능을 사용하려면 @EnableScheduling 어노테이션을 부여해둬야 한다.

### 테스크(Task) 구현

테스크의 경우 API 형식으로 만들 수 있다.
- 만약 테스크가 크다면? (= 타임아웃이 날 만큼 오래 걸리는 작업)
	- API를 세분화하여 해결할 수 있다.
		- 데이터를 읽는 API
		- 데이터를 처리하는 API

### 스케줄러 - Cronjob 활용

Cron은 Unix 계열 컴퓨터 운영 체제의 시간 기반 Job 스케줄러이다. 특정 작업을 고정된 시간, 날짜, 간격에 주기적으로 실행할 수 있도록 스케줄링하기 위해 Cron을 활용한다. 

Cron의 명령어는 초, 분, 시간, 일, 월, 주 단계로 사용할 수 있다.
- `second, min, hour, day, month, weekday`

> 스프링 애플리케이션에 기능을 메서드 형태로 만들어 두고 @Scheduled 어노테이션으로 활용할 수 있다.

### @Scheduled 주의 사항

실무 환경에서는 보통 동일한 작업을 하는 서버가 2대 이상 운영되고 있다. 만약 @Scheduled가 적용된 상태에서 2대 이상의 서버에 배포가 된다면 동일한 시간에 모든 서버에서 동일한 작업이 수행되며 작업에 고객에게 알람을 보내는 배치일 경우 서버의 개수만큼 알람을 받을 수 있기 때문에 특정 서버에서만 @Scheduled가 동작하도록 설정을 하거나, 운영 환경에서의 사용은 지양하는 것이 좋다.

#### Jenkins 활용 사례

일반적으로는 어러 대의 서버에 트래픽을 분산시켜주는 로드 밸런서가 존재한다. 요청을 해당 로드 밸런서로 보내게 되면 내부 로직에 의해 알아서 요청을 분산시켜준다.

Jenkins는 개발 작업을 자동화하거나 파이프라인을 구축할 수 있도록 도와주는 도구로 스케줄링 역할을 Jenkins가 수행하게 할 수 있다. 배치 작업으로 수행되어야 하는 기능을 API로 만들고, Jenkins가 해당 API를 로드 밸런서를 통해 호출하는 것이다. 

예시로 전날 상품 구매가 일어난 고객을 대상으로 감사 문자를 보내는 배치를 만든다고 해보자.
- 방법 1. 요청 한 번에 모든 작업을 다 처리
	- 요청 발생 -> 전날 상품 구매가 일어난 고객 조회 -> 각 고객 별 감사 문자 보내기
- 방법 2. 요청을 각 고객 별로 보내기
	- 조회 요청 발생 -> 전날 상품 구매가 일어난 고객을 조회하여 반환 -> Jenkins에서 고객 리스트를 순회하며 각 고객에 대한 감사 문자를 보내는 API를 호출함

주로 안정성과 실패했을 때의 상황을 생각하기 때문에 2번 방법을 활용한다.

#### Airflow

Jenkins 뿐만 아니라 Apache Airflow를 활용할 수도 있다. 파이프라인을 수행할 때 안정성이 높고, 실행에 대한 모니터링 기능을 제공하는 오픈소스 플랫폼이다.

#### Github Action

Github에서 제공하는 Github Action도 스케줄러로 활용할 수 있다. 스크립트 파일을 만들어서 특정 시각에 작업을 할 수 있도록 한다.

