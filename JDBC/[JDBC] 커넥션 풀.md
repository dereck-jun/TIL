## 커넥션 풀이란?

데이터베이스와 연결된 커넥션을 미리 만들어 놓고 이를 pool로 관리하는 것이다. 일정량의 (보통 10개) Connection 객체를 미리 만들어 두었다가 요청 시 꺼내서 사용한다.

커넥션 풀에서 커넥션을 생성하는 작업은 애플리케이션 실행 속도에 영향을 주지 않기 위해 별도의 `Thread` 에서 작동한다. 별도의 `Thread` 에서 동작하기 때문에 쓰레드 풀에 커넥션이 생성되는 로그를 확인하려면 `Thread.sleep()` 을 통해 대기 시간을 줘야 확인할 수 있다.

커넥션 풀은 `setMaximumPoolSize(n)` 으로 커넥션 풀의 최대 크기를 지정할 수 있다. 이때 스프링 부트에서 `HikariCP` 의 기본적으로 생성하고 유지해놓을 커넥션 수는 커넥션 풀의 최대 크기와 동일하기 때문에 설정한 최대 크기만큼 커넥션을 생성해놓고 시작한다.
- 이는 `minimumIdle` 값을 조정하는 것으로 변경할 수 있다.

결론적으로 필요할 때마다 커넥션 풀의 커넥션을 이용하고 반환하는 기법이다.


## JDBC 커넥션 풀
### 데이터베이스 커넥션을 매번 획득할 때

데이터베이스 커넥션을 획득할 때는 다음과 같은 복잡한 과정을 거친다.

1. 애플리케이션 로직은 **DB 드라이버를 통해 커넥션을 조회**한다.
2. DB 드라이버는 DB와 `TCP/IP` 커넥션이 연결한다. 물론 이 과정에서 `3 way handshake` 같은 `TCP/IP` 연결을 위한 **네트워크 동작이 발생**한다.
3. DB 드라이버는 DB와 `TCP/IP` 커넥션이 연결되면 **ID, PW와 기타 부가정보를 DB에 전달**한다.
4. DB 는 ID, PW를 통해 **내부 인증**을 완료하고, **내부에 DB 세션을 생성**한다.
5. DB는 **커넥션 생성이 완료되었다는 응답**을 보낸다.
6. DB 드라이버는 **커넥션 객체를 생성해서 클라이언트에 반환**한다.

이렇게 커넥션을 새로 만드는 것은 과정도 복잡하고 시간도 많이 소모되는 일이다. (= 자원이 많이 소모되는 일이다)

DB는 물론이고 애플리케이션 서버에서도 `TCP/IP` 커넥션을 새로 생성하기 위한 리소스를 매번 사용해야 한다.

진짜 문제는 고객이 애플리케이션을 사용할 때, SQL을 **실행하는 시간 뿐만 아니라 커넥션을 새로 만드는 시간이 추가되기 때문에 결과적으로 응답 속도에 영향**을 주어 사용자에게 **좋지 않은 경험**을 줄 수 있다.

> **참고**
> 
> 데이터베이스(mysql, ms-sql, H2 ...)마다 커넥션을 생성하는 시간은 다르다.


### 커넥션 풀 초기화

1. 커넥션 조회
	- 커넥션 풀 -> DB 드라이버
2. 커넥션 반환 및 TCP/IP 커넥션 연결
	- DB 드라이버 -> 커넥션 풀
	- DB 드라이버 -> DB
3. ID, PW, 부가 정보 전달
	- DB 드라이버 -> DB
4. 인증 + DB 세션 생성
	- DB 내부
5. 커넥션 생성 완료
	- DB -> DB 드라이버

**애플리케이션을 시작하는 시점**에 커넥션 풀은 필요한 만큼 **커넥션을 미리 확보**해서 풀에 보관한다.
얼마나 보관할 지는 서비스의 특징과 서버 스펙에 따라 다르지만 기본값은 10개이다.

### 커넥션 풀의 연결 상태

**커넥션 풀에 들어 있는 커넥션**은 TCP/IP로 DB와 커넥션이 **연결되어 있는 상태**이기 때문에 **언제든지 즉시 SQL을 DB에 전달**할 수 있다.

#### 커넥션 풀 사용

1. 클라이언트가 애플리케이션 로직에 요청
2. 애플리케이션 로직이 커넥션 풀에 커넥션 조회
3. 애플리케이션 로직이 커넥션 풀로부터 커넥션 획득
4. 커넥션 사용
5. 커넥션 풀에 반환

- 애플리케이션 로직에서 이제는 DB 드라이버를 통해서 새로운 커넥션을 획득하는 것이 아니다.
- 이제는 커넥션 풀을 통해 이미 생성되어 있는 커넥션을 객체 참조로 그냥 가져다 쓰기만 하면 된다.
- 커넥션 풀에 커넥션을 요청하면 커넥션 풀은 자신이 가지고 있는 커넥션 중에 하나를 반환한다.
- 애플리케이션 로직은 커넥션 풀에서 받은 커넥션을 사용해서 SQL을 데이터베이스에 전달하고 그 결과를 받아서 처리한다.
- 커넥션을 모두 사용하고 나면 이제는 커넥션을 종료하는 것이 아니라, 다음에 다시 시작할 수 있도록 해당 커넥션을 그대로 커넥션 풀에 반환하면 된다.
	- 주의할 점: 커넥션을 종료하는 것이 아니라 **커넥션이 살아있는 상태로 커넥션 풀에 반환**해야 한다는 것
	- `close()` 호출 시 커넥션이 종료되는 것이 아닌 **커넥션 풀로 반환**된다.

## 정리

- 적절한 커넥션 풀 숫자는 서비스의 특징과 애플리케이션 서버 스펙, DB 서버 스펙에 따라 다르기 때문에 성능 테스트를 통해서 정해야 한다.
- 커넥션 풀은 서버당 최대 커넥션 수를 제한할 수 있다. 따라서 DB에 무한정 연결이 생성되는 것을 막아주어서 DB를 보호하는 효과도 있다.